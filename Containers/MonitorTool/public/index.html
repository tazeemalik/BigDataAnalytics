<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>MonitorTool - cljDetector</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .row { display:flex; gap:16px; align-items:flex-start; }
    #chart { width: 70%; }
    #status { width: 30%; max-height: 600px; overflow:auto; background:#f5f5f5; padding:8px; border-radius:6px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    td, th { padding:6px; border:1px solid #ddd; }
  </style>
</head>
<body>
  <h1>MonitorTool - cljDetector</h1>
  <div class="row">
    <div id="chart">
      <canvas id="myChart"></canvas>
    </div>
    <div id="status">
      <h3>Status updates</h3>
      <div id="updates"></div>
      <h3>Summary</h3>
      <div id="summary"></div>
    </div>
  </div>

  <h2>Processing Timeline Summary</h2>
  <table id="summaryTable">
    <thead>
      <tr><th>Processing Step</th><th>Database Collection</th><th>#Items</th><th>Processing Time</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const ctx = document.getElementById('myChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'files', data: [], borderColor: 'blue', fill:false, tension:0.2 },
          { label: 'chunks', data: [], borderColor: 'pink', fill:false, tension:0.2 },
          { label: 'candidates', data: [], borderColor: 'orange', fill:false, tension:0.2 },
          { label: 'clones', data: [], borderColor: 'gold', fill:false, tension:0.2 }
        ]
      },
      options: {
        animation: false,
        scales: { x: { display: true, ticks: { maxRotation: 90, minRotation: 45 } } }
      }
    });

    async function fetchData() {
      const [samplesRes, statusRes, summaryRes] = await Promise.all([
        fetch('/api/samples?limit=1000'),
        fetch('/api/status?limit=30'),
        fetch('/api/summary')
      ]);
      const [samples, status, summary] = await Promise.all([samplesRes.json(), statusRes.json(), summaryRes.json()]);
      return { samples, status, summary };
    }

    function renderStatus(status) {
      const updates = document.getElementById('updates');
      updates.innerHTML = '';
      status.forEach(s=>{
        const d = new Date(s.ts).toISOString();
        const div = document.createElement('div');
        div.style.marginBottom = '8px';
        div.innerHTML = `<b>${d}</b><div>${s.message || s.msg || ''}</div>`;
        updates.appendChild(div);
      });
    }

    function renderSummaryTable(procSummary) {
      const tbody = document.querySelector('#summaryTable tbody');
      tbody.innerHTML = '';
      procSummary.forEach(r=>{
        const tr = document.createElement('tr');
        ['step','collection','items','time'].forEach(k=>{
          const td = document.createElement('td');
          td.textContent = (k==='collection')? r.collection : (k==='items'? r.items : (k==='time'? r.time : r.step));
          if(k==='items' && typeof r.items === 'number') td.textContent = r.items.toLocaleString();
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function renderChart(samples) {
      const labels = samples.map(s => {
        const d = new Date(s.ts);
        return d.toISOString().substr(11,8); // time
      });
      const files = samples.map(s=>s.files);
      const chunks = samples.map(s=>s.chunks);
      const candidates = samples.map(s=>s.candidates);
      const clones = samples.map(s=>s.clones);

      chart.data.labels = labels;
      chart.data.datasets[0].data = files;
      chart.data.datasets[1].data = chunks;
      chart.data.datasets[2].data = candidates;
      chart.data.datasets[3].data = clones;
      chart.update();
    }

    async function refreshUI() {
      try {
        const { samples, status, summary } = await fetchData();
        renderChart(samples);
        renderStatus(status);
        if (summary && summary.processingSummary) {
          renderSummaryTable(summary.processingSummary);
        }
      } catch (e) {
        console.error('refresh error', e);
      }
    }

    // initial load + periodic refresh
    refreshUI();
    setInterval(refreshUI, 5000);
  </script>
</body>
</html>
